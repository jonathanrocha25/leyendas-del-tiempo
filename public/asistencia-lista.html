<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lista de Asistencia</title>
<link rel="stylesheet" href="/style.css" />
<style>
  .card { background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border: 1px solid rgba(255,255,255,.15); border-radius: 16px; padding: 20px; max-width: 900px; margin: 24px auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 16px; }
  th, td { padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,.15); text-align: left; }
  th { background: rgba(255,255,255,.08); }
  tr:hover { background: rgba(255,255,255,.05); }
  .actions { display: flex; justify-content: space-between; margin-top: 16px; flex-wrap: wrap; gap: 8px; }
  .delete-btn { cursor: pointer; background: none; border: none; color: #ff6b6b; font-size: 1.2rem; }
  .delete-btn:hover { color: #ff2e2e; }

  /* ‚úÖ Notificaci√≥n */
  .toast {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0,0,0,0.85);
    color: #fff;
    padding: 14px 20px;
    border-radius: 8px;
    font-size: 1rem;
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity .3s, transform .3s;
    z-index: 9999;
  }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.success { background: #1db954; }
  .toast.error { background: #ff4c4c; }
  .toast.info { background: #007bff; }

  /* üìä Contador */
  .counter {
    font-size: 1.4rem;
    font-weight: bold;
    margin: 20px 0;
    text-align: center;
    padding: 12px;
    border-radius: 12px;
    background: rgba(0, 75, 141, 0.15);
    border: 1px solid rgba(0,75,141,0.4);
  }
  .counter span { font-size: 2rem; color: #1db954; }
</style>
</head>
<body class="layout">
  <header class="header">
    <img src="/brand/logo-cencosud.webp" class="logo" alt="Cencosud" />
    <h1 class="title">Lista de Asistencia</h1>
  </header>

  <main class="card">
    <div class="actions">
      <button id="refresh" class="btn">üîÑ Actualizar lista</button>
      <a href="/api/asistencia.js?export" class="btn">üì• Descargar CSV</a>
      <button id="clearAll" class="btn btn--danger">üßπ Borrar todos</button>
    </div>

    <!-- üìä Contador din√°mico -->
    <div id="counter" class="counter">
      üë• Total registrados: <span>0</span> personas
    </div>

    <table>
      <thead>
        <tr>
          <th>C√©dula</th>
          <th>Nombre</th>
          <th>Cargo</th>
          <th>Antig√ºedad</th>
          <th>Hora</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla">
        <tr><td colspan="6">‚è≥ Cargando registros...</td></tr>
      </tbody>
    </table>
  </main>

  <footer class="footer">
    <a class="btn btn--ghost" href="/">Volver</a>
    <a class="btn" href="/asistencia.html">Registrar asistencia</a>
  </footer>

  <div id="toast" class="toast"></div>

<script>
function showToast(message, type = "info") {
  const toast = document.getElementById("toast");
  toast.className = `toast show ${type}`;
  toast.textContent = message;
  setTimeout(() => { toast.className = "toast"; }, 3000);
}

async function cargarAsistencia(showToastMessage = false) {
  const tbody = document.getElementById("tabla");
  const counter = document.querySelector("#counter span");
  tbody.innerHTML = `<tr><td colspan="6">‚è≥ Cargando registros...</td></tr>`;

  try {
    const r = await fetch("/api/asistencia.js?list");
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "Error cargando registros");

    const items = j.items || {};
    const keys = Object.keys(items);
    counter.textContent = keys.length; // ‚úÖ Actualiza contador en tiempo real

    if (keys.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">üì≠ A√∫n no hay registros</td></tr>`;
      return;
    }

    tbody.innerHTML = keys.map(ced => {
      const d = items[ced];
      return `
        <tr>
          <td>${ced}</td>
          <td>${d.nombre || "-"}</td>
          <td>${d.cargo || "-"}</td>
          <td>${d.antiguedad || "-"}</td>
          <td>${new Date(d.hora).toLocaleString()}</td>
          <td><button class="delete-btn" onclick="eliminarAsistencia('${ced}')">üóëÔ∏è</button></td>
        </tr>
      `;
    }).join("");

    if (showToastMessage) showToast("üîÑ Lista actualizada", "info");
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="6" style="color:#ffb4b4">‚ùå ${e.message}</td></tr>`;
    showToast("‚ùå Error al cargar registros", "error");
  }
}

async function eliminarAsistencia(cedula) {
  if (!confirm(`‚ö†Ô∏è ¬øSeguro que deseas eliminar la asistencia de ${cedula}?`)) return;
  try {
    const res = await fetch(`/api/asistencia.js?cedula=${cedula}`, { method: "DELETE" });
    const data = await res.json();
    if (data.ok) {
      showToast(`‚úÖ Registro ${cedula} eliminado`, "success");
      await cargarAsistencia();
    } else {
      showToast(`‚ùå Error eliminando registro: ${data.error}`, "error");
    }
  } catch (e) {
    showToast("‚ùå Error al eliminar registro", "error");
  }
}

document.getElementById("clearAll").addEventListener("click", async () => {
  if (!confirm("‚ö†Ô∏è Esto eliminar√° TODOS los registros de asistencia. ¬øEst√°s seguro?")) return;
  try {
    const res = await fetch("/api/asistencia.js?clear", { method: "DELETE" });
    const data = await res.json();
    if (data.ok) {
      showToast("üßπ Todos los registros fueron eliminados", "success");
      await cargarAsistencia();
    } else {
      showToast(`‚ùå Error eliminando registros: ${data.error}`, "error");
    }
  } catch (e) {
    showToast("‚ùå Error al eliminar todos los registros", "error");
  }
});

document.getElementById("refresh").addEventListener("click", () => cargarAsistencia(true));

// üîÑ Refresco autom√°tico cada 5 s
setInterval(() => cargarAsistencia(), 5000);

window.addEventListener("DOMContentLoaded", cargarAsistencia);
</script>
</body>
</html>
