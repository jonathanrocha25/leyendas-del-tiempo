<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lista de Asistencia</title>
<link rel="stylesheet" href="/style.css" />
<style>
  .card {
    background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    border: 1px solid rgba(255,255,255,.15);
    border-radius: 16px;
    padding: 20px;
    max-width: 900px;
    margin: 24px auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }
  th, td {
    padding: 8px 12px;
    border-bottom: 1px solid rgba(255,255,255,.15);
    text-align: left;
  }
  th {
    background: rgba(255,255,255,.08);
    font-weight: bold;
  }
  tr:hover { background: rgba(255,255,255,.05); }
  .actions {
    display: flex;
    justify-content: space-between;
    margin-top: 16px;
  }
</style>
</head>
<body class="layout">
  <header class="header">
    <img src="/brand/logo-cencosud.webp" class="logo" alt="Cencosud" />
    <h1 class="title">Lista de Asistencia</h1>
  </header>

  <main class="card">
    <div class="actions">
      <button id="refresh" class="btn">üîÑ Actualizar lista</button>
      <a href="/api/asistencia.js?export" class="btn">üì• Descargar CSV</a>
    </div>

    <div id="total" style="margin:12px 0;font-weight:bold;"></div>

    <table>
      <thead>
        <tr>
          <th>C√©dula</th>
          <th>Nombre</th>
          <th>Cargo</th>
          <th>Antig√ºedad</th>
          <th>Hora de registro</th>
        </tr>
      </thead>
      <tbody id="tabla">
        <tr><td colspan="5">‚è≥ Cargando registros...</td></tr>
      </tbody>
    </table>
  </main>

  <footer class="footer">
    <a class="btn btn--ghost" href="/">Volver</a>
    <a class="btn" href="/asistencia.html">Registrar nueva asistencia</a>
  </footer>

<script>
async function cargarAsistencia() {
  const tbody = document.getElementById("tabla");
  const total = document.getElementById("total");
  tbody.innerHTML = `<tr><td colspan="5">‚è≥ Cargando registros...</td></tr>`;

  try {
    const r = await fetch("/api/asistencia.js?list");
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || "Error cargando registros");

    const items = j.items || {};
    const keys = Object.keys(items);

    total.textContent = `üë• Total registrados: ${keys.length}`;
    if (keys.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">üì≠ A√∫n no hay registros</td></tr>`;
      return;
    }

    tbody.innerHTML = keys.map(ced => {
      const d = items[ced];
      return `
        <tr>
          <td>${ced}</td>
          <td>${d.nombre || "-"}</td>
          <td>${d.cargo || "-"}</td>
          <td>${d.antiguedad || "-"}</td>
          <td>${new Date(d.hora).toLocaleString()}</td>
        </tr>
      `;
    }).join("");
  } catch (e) {
    console.error(e);
    tbody.innerHTML = `<tr><td colspan="5" style="color:#ffb4b4">‚ùå Error cargando datos</td></tr>`;
  }
}

document.getElementById("refresh").addEventListener("click", cargarAsistencia);
window.addEventListener("DOMContentLoaded", cargarAsistencia);
</script>
</body>
</html>
